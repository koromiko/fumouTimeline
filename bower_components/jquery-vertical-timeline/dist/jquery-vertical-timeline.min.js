/*! jquery-vertical-timeline - v0.3.0 - 2014-01-29
* https://github.com/MinnPost/jquery-vertical-timeline
* Copyright (c) 2014 MinnPost; Licensed MIT */

!function(a,b){if("undefined"!=typeof module&&module.exports&&"function"==typeof require)b(require("jquery"),require("underscore"),require("tabletop"),require("isotope"),require("imagesloaded"),require("moment"));else if("function"==typeof define&&define.amd)define("jquery-vertical-timeline",["jquery","underscore","tabletop","moment","isotope","imagesloaded"],b);else{if(!(a.jQuery&&a._&&a.Tabletop&&a.moment&&a.jQuery.fn.isotope&&a.jQuery.fn.imagesLoaded))throw new Error("Could not find dependencies for jQuery Vertical Timeline.");b(a.jQuery,a._,a.Tabletop,a.moment,a.jQuery.fn.isotope,a.jQuery.fn.resize,a.jQuery.fn.imagesLoaded)}}("undefined"!=typeof window?window:this,function(a,b,c,d){var e={key:"https://docs.google.com/spreadsheet/pub?key=0AsmHVq28GtVJdG1fX3dsQlZrY18zTVA2ZG8wTXdtNHc&output=html",sheetName:"Posts",dateParse:["MMM DD, YYYY","MM/DD/YYYY","M/D/YYYY","DD MMM YYYY"],defaultDirection:"newest",defaultExpansion:"expanded",groupFunction:"groupSegmentByYear",sharing:!1,gutterWidth:57,width:"auto",handleResize:!1,tabletopOptions:{},columnMapping:{title:"title",title_icon:"title icon",date:"date",display_date:"display date",photo_url:"photo url",caption:"caption",body:"body",read_more_url:"read more url"},postTemplate:'<div class="item post <%= options.defaultExpansion %>" data-timestamp="<%= data.timestamp %>">         <div class="inner">           <div class="title">             <h3>               <% if (data.title_icon) { %><img class="title-icon" src="<%= data.title_icon %>" /><% } %>               <%= data.title %>             </h3>           </div>           <div class="date"><%= data.display_date %></div>           <div class="body">             <% if (data.photo_url) { %>               <img src="<%= data.photo_url %>" alt="">             <% } %>             <% if (data.caption) { %>               <div class="caption"><%= data.caption %></div>             <% } %>             <% if (data.body) { %>                <div class="text"><%= data.body %></div>             <% } %>             <div class="clearfix">               <% if (data.read_more_url) { %>                 <a target="_blank" class="more" href="<%= data.read_more_url %>">Read more</a>               <% } %>             </div>           </div>           <a href="#" class="open-close"></a>         </div>       </div>     ',groupMarkerTemplate:'<div class="item group-marker item-group-<%= data.id %>" data-id="<%= data.id %>" data-timestamp="<%= data.timestamp %>">         <div class="inner">           <div class="inner2">             <div class="group"><%= data.groupDisplay %></div>           </div>         </div>       </div>     ',buttonTemplate:'<div class="vertical-timeline-buttons clearfix">         <div class="expand-collapse-buttons">           <a class="expand-all <% if (data.defaultExpansion == "expanded") { %>active<% } %>" href="#"><span>Expand all</span></a>           <a class="collapse-all <% if (data.defaultExpansion == "collapsed") { %>active<% } %>" href="#"><span>Collapse all</span></a>         </div>         <div class="sort-buttons">           <a class="sort-newest <% if (data.defaultDirection == "newest") { %>active<% } %>" href="#"><span>Newest first</span></a>           <a class="sort-oldest <% if (data.defaultDirection == "oldest") { %>active<% } %>" href="#"><span>Oldest first</span></a>         </div>       </div>     ',timelineTemplate:'<div class="vertical-timeline-timeline">         <div class="line-container">           <div class="line"></div>         </div>         <%= data.posts %>         <%= data.groups %>       </div>     ',loadingTemplate:'<div class="loading">         Loading...       </div>     '},f={};f.groupSegmentByDecade=function(a,c,e){var f=a.date.year(),g=f.toString(),h=g.slice(0,-1),i=d(h+"0-01-01T00:00:00"),j=d(h+"9-12-31T12:59:99");return b.isUndefined(c[h])&&(c[h]={id:h,groupDisplay:h+"0's",timestamp:"newest"==e?j.unix():i.unix(),timestampStart:i.unix(),timestampEnd:j.unix()}),c},f.groupSegmentByYear=function(a,c,e){var f=a.date.year(),g=d(f+"-01-01T00:00:00"),h=d(f+"-12-31T12:59:99");return b.isUndefined(c[f.toString()])&&(c[f.toString()]={id:f,groupDisplay:f,timestamp:"newest"==e?h.unix():g.unix(),timestampStart:g.unix(),timestampEnd:h.unix()}),c},f.groupSegmentByDay=function(a,b,c){var d=new Date(a.timestamp).getMonth(),e=new Date(a.timestamp).getFullYear(),f=new Date(a.timestamp).getDate(),g=["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"],h=Date.parse(g[d]+" "+f+", "+e),i=Date.parse(g[d]+" "+(f+1)+", "+e),j=f+100*(d+100*e);return b[j]={id:j,groupDisplay:g[d]+" "+f+", "+e,timestamp:"newest"==c?i:h,timestampStart:h,timestampEnd:i},b};var g=function(c,d){this.options=a.extend(!0,{},e,d),this.options.groupFunction=!b.isFunction(this.options.groupFunction)&&b.isFunction(f[this.options.groupFunction])?f[this.options.groupFunction]:this.options.groupFunction,this.$el=a(c),this.templates={},this.templates.post=b.template(this.options.postTemplate),this.templates.group=b.template(this.options.groupMarkerTemplate),this.templates.buttons=b.template(this.options.buttonTemplate),this.templates.timeline=b.template(this.options.timelineTemplate),this.templates.loading=b.template(this.options.loadingTemplate),this.loadEvents(),this.$el.trigger("vt.build")};return b.extend(g.prototype,{events:{"vt.build":["buildLayout"],"vt.layoutBuilt":["getData"],"vt.gotData":["parseData"],"vt.parsedData":["buildTimeline"],"vt.builtTimeline":["loadImages","adjustWidth"],"vt.loadedImages":["isotopeIt"],"vt.isotopized":["adjustWidth","adjustSpine","domEvents"]},loadEvents:function(){b.each(this.events,function(a,c){b.each(a,function(a){b.isFunction(this[a])&&this.$el.on(c,b.bind(this[a],this))},this)},this)},buildLayout:function(){this.$el.addClass("vertical-timeline-container"),this.$el.html(this.templates.buttons({data:this.options})+this.templates.loading({})),this.$el.trigger("vt.layoutBuilt")},getData:function(){var a=this;b.isArray(this.options.data)&&this.options.data.length>0?(this.data=this.options.data,this.$el.trigger("vt.gotData")):c.init(b.extend({},this.options.tabletopOptions,{key:this.options.key,wanted:[this.options.sheetName],callback:function(b,c){a.data=b[a.options.sheetName].elements,a.tabletop=c,a.$el.trigger("vt.gotData")}}))},parseData:function(){this.groups=this.groups||{},this.data=b.map(this.data,function(a){return b.each(this.options.columnMapping,function(c,d){c=c.split(" ").join(""),b.isUndefined(a[c])||(a[d]=a[c])}),a.date=d(a.date,this.options.dateParse),a.timestamp=a.date.unix(),this.groups=this.options.groupFunction(a,this.groups,this.options.defaultDirection),a},this),this.$el.trigger("vt.parsedData")},buildTimeline:function(){this.$el.append(this.templates.timeline({data:{posts:b.map(this.data,function(a){return this.templates.post({data:a,options:this.options})},this).join(" "),groups:b.map(this.groups,function(a){return this.templates.group({data:a})},this).join(" ")}})),this.$timeline=this.$el.find(".vertical-timeline-timeline"),this.$el.trigger("vt.builtTimeline")},loadImages:function(){this.$el.imagesLoaded(b.bind(function(){this.$el.find(".loading").slideUp(),this.$timeline.fadeIn("fast",b.bind(function(){this.$el.trigger("vt.loadedImages")},this))},this))},isotopeIt:function(){this.$el.find(".vertical-timeline-timeline").isotope({itemSelector:".item",transformsEnabled:!0,layoutMode:"spineAlign",spineAlign:{gutterWidth:this.options.gutterWidth},getSortData:{timestamp:function(a){return parseFloat(a.data("timestamp"))}},sortBy:"timestamp",sortAscending:"newest"===this.options.defaultDirection?!1:!0,itemPositionDataEnabled:!0,onLayout:b.bind(function(){this.$el.trigger("vt.isotopized")},this),containerStyle:{position:"relative"}})},adjustWidth:function(){var a,b,c=this.options.width,d=this.$el.width();"auto"===c&&(c=d+"px"),this.$timeline.css("width",c),a=this.$timeline.width(),b=a/2-this.options.gutterWidth/2-3,this.$timeline.find(".post").width(b)},adjustSpine:function(){var a=this.$el.find(".item.last"),b=a.data("isotope-item-position"),c=a.find(".date").height(),d=a.find(".date").position(),e=parseInt(a.find(".inner").css("marginTop"),10),f=void 0===d?0:parseInt(d.top,10),g=b&&b.y?parseInt(b.y,10):0,h=g+e+f+c/2,i=this.$el.find(".line"),j=this.$timeline.width()/2-i.width()/2;i.height(h).css("left",j+"px")},domEvents:function(){return this.domEventsAdded?void this.$el.trigger("vt.domEventsAdded"):(this.$el.find(".item a.open-close").on("click",b.bind(function(c){c.preventDefault();var d=a(c.currentTarget),e=d.parents(".post"),f=e.hasClass("collapsed")?"slideDown":"slideUp";d.siblings(".body")[f](b.bind(function(){e.toggleClass("collapsed").toggleClass("expanded"),this.$timeline.isotope("reLayout")},this)),this.$el.find(".expand-collapse-buttons a").removeClass("active")},this)),this.$el.find(".vertical-timeline-buttons a.expand-all").on("click",b.bind(function(b){b.preventDefault();var c=a(b.currentTarget),d=this;this.$el.find(".post .body").slideDown(function(){d.$timeline.isotope("reLayout")}),this.$el.find(".post").removeClass("collapsed").addClass("expanded"),this.$el.find(".expand-collapse-buttons a").removeClass("active"),c.addClass("active")},this)),this.$el.find(".vertical-timeline-buttons a.collapse-all").on("click",b.bind(function(b){b.preventDefault();var c=a(b.currentTarget),d=this;this.$el.find(".post .body").slideUp(function(){d.$timeline.isotope("reLayout")}),this.$el.find(".post").addClass("collapsed").removeClass("expanded"),this.$el.find(".expand-collapse-buttons a").removeClass("active"),c.addClass("active")},this)),this.$el.find(".sort-buttons a").on("click",b.bind(function(b){b.preventDefault();var c=a(b.currentTarget);return c.hasClass("active")?!1:(this.$el.find(".sort-buttons a").removeClass("active"),c.addClass("active"),void this.updateGroups(c.hasClass("sort-newest")?"newest":"oldest"))},this)),this.options.handleResize===!0&&b.isFunction(this.$el.resize)&&this.$el.resize(b.throttle(b.bind(function(){this.$el.trigger("vt.isotopized")},this),200)),this.domEventsAdded=!0,void this.$el.trigger("vt.domEventsAdded"))},updateGroups:function(b){var c=this;b=b||this.options.defaultDirection,this.$el.find(".group-marker").each(function(){var d=a(this),e="newest"!==b?c.groups[d.data("id")].timestampStart:c.groups[d.data("id")].timestampEnd;d.data("timestamp",e)}),this.$timeline.isotope("reloadItems").isotope({sortAscending:"newest"!==b})}}),b.extend(a.Isotope.prototype,{_spineAlignReset:function(){this.spineAlign={colA:0,colB:0,lastY:-60}},_spineAlignLayout:function(b){var c=this,d=this.spineAlign,e=Math.round(this.options.spineAlign&&this.options.spineAlign.gutterWidth)||0,f=Math.round(this.element.width()/2);b.each(function(g){var h,i,j=a(this);if(j.removeClass("last").removeClass("top"),g==b.length-1&&j.addClass("last"),j.hasClass("group-marker")){var k=j.width();h=f-k/2,d.colA>=d.colB?(i=d.colA,0===i&&j.addClass("top"),d.colA+=j.outerHeight(!0),d.colB=d.colA):(i=d.colB,0===i&&j.addClass("top"),d.colB+=j.outerHeight(!0),d.colA=d.colB)}else{j.removeClass("left").removeClass("right");var l=d.colB>=d.colA;if(j.addClass(l?"left":"right"),h=l?f-(j.outerWidth(!0)+e/2):f+e/2,i=l?d.colA:d.colB,i-d.lastY<=60){var m=60-Math.abs(i-d.lastY);j.find(".inner").css("marginTop",m),d.lastY=i+m}else j.find(".inner").css("marginTop",0),d.lastY=i;d[l?"colA":"colB"]+=j.outerHeight(!0)}c._pushPosition(j,h,i)})},_spineAlignGetContainerSize:function(){var a={};return a.height=this.spineAlign[this.spineAlign.colB>this.spineAlign.colA?"colB":"colA"],a},_spineAlignResizeChanged:function(){return!0}}),a.fn.verticalTimeline=function(b){return this.each(function(){a.data(this,"verticalTimeline")||a.data(this,"verticalTimeline",new g(this,b))})},g});